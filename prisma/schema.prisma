// Pokemon Wordle TCG - Prisma Schema
// Database schema for Pokemon Wordle game with TCG card collection

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User roles for access control
enum UserRole {
  TRAINER @map("Trainer")
  ADMIN   @map("admin")
}

// User model - represents application users
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  role      UserRole @default(TRAINER)
  level     Int      @default(1)
  experience Int     @default(0)
  balance   Decimal  @default(0.00) @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  games             Game[]
  userCards         UserCard[]
  pokedexEntries    PokedexEntry[]
  pityTracker       PityTracker?
  tradesAsSender    Trade[] @relation("TradeSender")
  tradesAsReceiver  Trade[] @relation("TradeReceiver")
}

// Biome model - different environments where Pokemon spawn
model Biome {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  imageUrl    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  spawns      PokemonSpawn[]
  games       Game[]
}

// Pokemon model - Pokemon that can be encountered in the Wordle game
model Pokemon {
  id              Int      @id @default(autoincrement())
  name            String   @unique
  pokedexNumber   Int
  type1           String
  type2           String?
  evolutionStage  Int      // 1, 2, or 3
  fullyEvolved    Boolean
  color           String
  generation      Int      // 1-9
  imageUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  spawns          PokemonSpawn[]
  games           Game[]
  cards           Card[]
  guessesAsGuess  Guess[]

  @@index([pokedexNumber])
  @@index([type1])
  @@index([generation])
}

// PokemonSpawn - defines which Pokemon appear in which biomes at what time
model PokemonSpawn {
  id              Int      @id @default(autoincrement())
  pokemonId       Int
  biomeId         Int
  timeOfDay       String   // "day", "night", "both"
  spawnWeight     Float    @default(1.0)
  createdAt       DateTime @default(now())

  // Relations
  pokemon         Pokemon  @relation(fields: [pokemonId], references: [id], onDelete: Cascade)
  biome           Biome    @relation(fields: [biomeId], references: [id], onDelete: Cascade)

  @@unique([pokemonId, biomeId, timeOfDay])
  @@index([biomeId, timeOfDay])
  @@index([pokemonId])
}

// Card model - Pokemon TCG cards from TCGdex
model Card {
  id              Int      @id @default(autoincrement())
  tcgdexId        String   @unique
  pokemonId       Int
  pokemonName     String
  setId           String
  setName         String
  rarity          String   // TCG rarity from TCGdex
  tier            Int      // 1-6 based on performance tier
  imageUrl        String
  imageUrlLarge   String?
  isFloor         Boolean  @default(false)  // Lowest rarity in tier
  isCeiling       Boolean  @default(false)  // Highest rarity in tier
  weight          Float    @default(1.0)    // Drop weight
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  pokemon         Pokemon  @relation(fields: [pokemonId], references: [id], onDelete: Cascade)
  userCards       UserCard[]
  pokedexEntries  PokedexEntry[]

  @@index([pokemonId])
  @@index([tier])
  @@index([rarity])
}

// Game model - represents a single Wordle game session
model Game {
  id             Int      @id @default(autoincrement())
  userId         Int
  biomeId        Int
  timeOfDay      String   // "day" or "night"
  pokemonId      Int
  guessesUsed    Int?
  tier           Int?     // 1-6 based on tries (1=best, 6=worst)
  completed      Boolean  @default(false)
  won            Boolean  @default(false)
  offeredCardIds Json?    // Array of 3 card IDs offered after completion
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  biome          Biome    @relation(fields: [biomeId], references: [id], onDelete: Cascade)
  pokemon        Pokemon  @relation(fields: [pokemonId], references: [id], onDelete: Cascade)
  guesses        Guess[]
  capturedCard   UserCard?

  @@index([userId])
  @@index([pokemonId])
  @@index([completed])
  @@index([createdAt])
}

// Guess model - individual guess attempts in a game
model Guess {
  id         Int      @id @default(autoincrement())
  gameId     Int
  guessNum   Int      // 1-6
  pokemonId  Int
  feedback   Json     // {type1: 'correct'|'partial'|'wrong', type2: ..., evolutionStage: ..., fullyEvolved: ..., color: ..., generation: ...}
  createdAt  DateTime @default(now())

  // Relations
  game       Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  pokemon    Pokemon  @relation(fields: [pokemonId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([pokemonId])
}

// UserCard model - cards owned by users
model UserCard {
  id        Int      @id @default(autoincrement())
  userId    Int
  cardId    Int
  gameId    Int      @unique
  obtained  DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([userId, cardId])
  @@index([cardId])
}

// PokedexEntry model - tracks card discovery for Pokedex completion
model PokedexEntry {
  id         Int      @id @default(autoincrement())
  userId     Int
  cardId     Int
  discovered DateTime @default(now())

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  card       Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([userId, cardId])
  @@index([userId])
  @@index([cardId])
}

// PityTracker model - tracks pity system for gacha mechanics
model PityTracker {
  id                  Int       @id @default(autoincrement())
  userId              Int       @unique
  consecutiveTier6    Int       @default(0)
  consecutiveTier5    Int       @default(0)
  gamesWithoutCeiling Int       @default(0)  // Soft pity tracker
  hardPityCounter     Int       @default(0)  // Hard pity at 10
  totalGames          Int       @default(0)
  lastCeilingPull     DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Trade model - for future trading system (preserved)
model Trade {
  id            Int      @id @default(autoincrement())
  senderId      Int
  receiverId    Int
  senderCardId  Int
  receiverCardId Int?
  status        String   @default("pending") // pending, accepted, rejected, cancelled
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  sender        User     @relation("TradeSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver      User     @relation("TradeReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([status])
}
